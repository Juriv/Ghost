machine:
  environment:
    PROJECT_NAME: andrey-test-144809
    CLUSTER_NAME: ghost-cluster
    CLOUDSDK_COMPUTE_ZONE: us-central1-b
    DEBIAN_FRONTEND: noninteractive
    ACCT_AUTH: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiYW5kcmV5LXRlc3QtMTQ0ODA5IiwKICAicHJpdmF0ZV9rZXlfaWQiOiAiNGU4ODQyZWY5N2VjOGIzYzM1ZWE2NzE2MGM4NWE5OWRiNTNjZDRjNCIsCiAgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLVxuTUlJRXZRSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2N3Z2dTakFnRUFBb0lCQVFDbGRJSm5JbWFuWnBmalxuSy9HVlU0QjA1SkRDRlZxSmRSU0MyNHZHbWlqam9DMC9ZTjZyaVJFWFphV2lVWXdHaHdHV202MXArRmM0RS9Oc1xuYTB3UUVkUHhUT1BZNnpQdFI2RlZCaHdZNlJLZHJkQmVmVWtvR3FxeTJtZFo0d2pBUkdRVkFvdVJBU2Y4TzVkRlxuRzJGbDQ3SWlYVmJXZzVFTEFFblB4RWpvU29Xa3FrL2lKMmhCZ3h2NTNUR0VtaDI4eVFhMDJqUXRXQ0ZyN2lBMVxudU5ZRmQrV0NBU2dKMWpGdS9hNXV5TTAxcmZXWUUvdVBFS1RPNkVFWWdCYVd4d1U3bVRuY2dtZERvb3VoNUZzeFxuSm5rK3FSS2pYWFNRbVVYc2xlQzlHNWc2ak1FYlBCeU81N29BU0RYMVhYNlBKTHF3VjdodWtnS2prVFFxdXJRRFxuSlJ6MS9jZjlBZ01CQUFFQ2dnRUFDOHJkREhyQU5FZzBwU1ZacDVuMit0M2JqMm0wTlQzYUEyV2dkYnhCRTlBelxueVdPZkd6eStzaHMxamZjZjhzc21pdFIzcktqZGxvcWRlK205MXh0ZUxzR2JMN2U3MExxZFBoRWNhWTRiSEkvcFxuM1FJeTk1L0c4TTV1TlZMZ0tjdjJFaVZIUzBONDFScHVNcWU3N21ZbktSbmIrWmdRKzJhKzNBY1NaelFBaUhiWlxudUUxc2xWOURvb0xrSTk1eEN6dUk4YkhETHFpN1pEY1RYVnNHQ0lESGdvU2RaZGk5YXlab3ExRWY2VFNuQllHSVxucUk4RDJaR1Rxb054b2pINGU5ODd2aVZ1UkNWSzZCTUJlZnhMUnJSK2VvWCtiMDcxamVMWTBXVk1FckMzM3VDcVxuRWEwc2lQZ09VeHVva1d3UlNpMDVXNkh2OWptQVlCNVNKYmtTOThSOFpRS0JnUURTcjEzUlhzdWZQaWpwZ1RGQlxuZUpNMjFVbkw5ZmdUTkVScDlzMlUrZ0pjSEQyamt1UCs1amtNaXpLeDBwbFFhWEVMN3A3M2wxbW02WE9jci9wMlxuOWRkOGpscDN6Y09QSUNpd0thL3gremwybVpqeW1TZ1AxbVA2U25GNkZGMmNQSTNFQlFCOTVGd1llTzE5VjlmeFxuN2JwK3dUTW83VnMrSnZVZTRkeE5oVUlxT3dLQmdRREpDcmRZWE9OaS9KRGxRLzZLZzJ6RjR0QlJaTkIxMitSRVxubTlsZHJmaE53SVFjZU0xTVdxRjA2SG0wY1ZxczJLdDZEL0FYbm1ldFRtUlNrZ2tVVmxMak5kNElzY3huZCsxMFxuNzVSK09HNjQrWkxwQ21JenJ3Y08wNnBQc2RlSWE0Ny81ZmJsMWhFWDR3a21zdlo2N0FUL3dUKytJcVdmalNJR1xucjZpdTh1MTdKd0tCZ1FDUWlkRGlUNWVBVXlPOE5tNjFUT1FxTFI5b3R3R1BJeitBTnRxSlJ3K1JZNnFCNnNkUlxuMjEzdUZoMGNVNi9zczduamhydzJmZlg2aFpSVVBZS21WRGlXY2c3c3ZCUmF2NlJLWHY4ZkVzdzBhbUc4cFlnUFxuZlhTdmhKemZOTk9YMlE4bEdJMWkwT1RCd1V5a3Zqd2U5SW9LWmI4VVorbzk5SG9ieXJYWjFQODBld0tCZ0RjSlxuL2dQcytqdWhWYkhPbWFNbU0rTkJJek1GWEtUSG5JakQraEJSam9jS3k2QlgyaXlySzBTc1dKVno2eFVqQkY4WVxuZWV5ZGExamcrMG8zdk5DYWlYcTJ4cUN1dkgwZk1oMHZjZ0hVUlV2UzE4dUJFajJBRDNpWnJpaS9VWGlCcWRhWlxuQ0swSG5BcGtGNTlHbzRBbm1YN0RVMFlraWg5U0xoeVNmcVhXei9sRkFvR0FWWjNuc2pXM3dFRCtyR29QOU9acVxuRlJTZmJOdkVPL1hwdDgwS2hHaXVTNjBKNmdTMUdRdWxRZm9pbUdIODdKSm93V2o1ZER6UXdXYVpvNnZjeGladFxudkxGVHhBQy9UOEduaG1uVzd3RDdaeXpyNFQ1MmJGK0lrWkZxQS9pSmJscXRUV0Y0K1cxQVBlTFBmS3AxVW42WlxuNUNzRHJzSmJXVVRZR2JzNXVJRzJkdnM9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLAogICJjbGllbnRfZW1haWwiOiAiY29udGFpbmVyLWVuZ2luZUBhbmRyZXktdGVzdC0xNDQ4MDkuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTE1MzI5MTk4MTE0OTI3MDE1ODUzIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvY29udGFpbmVyLWVuZ2luZSU0MGFuZHJleS10ZXN0LTE0NDgwOS5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
  services:
    - docker

dependencies:
  pre:
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet components update kubectl
    - echo $ACCT_AUTH | base64 --decode -i > ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud auth activate-service-account --key-file ${HOME}/account-auth.json
    - sudo /opt/google-cloud-sdk/bin/gcloud config set project $PROJECT_NAME
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet config set container/cluster $CLUSTER_NAME
    # Reading the zone from the env var is not working so we set it here
    - sudo /opt/google-cloud-sdk/bin/gcloud config set compute/zone ${CLOUDSDK_COMPUTE_ZONE}
    - sudo /opt/google-cloud-sdk/bin/gcloud --quiet container clusters get-credentials $CLUSTER_NAME
    - docker build -t gcr.io/${PROJECT_NAME}/myghost:$CIRCLE_SHA1 .
    # Using a separate tag command until Docker 1.10 is available on CircleCI, then we can use two tags in the build command above
    - docker tag gcr.io/${PROJECT_NAME}/myghost:$CIRCLE_SHA1 gcr.io/${PROJECT_NAME}/myghost:latest

test:
  override:
  - echo "test"
  post:
    - docker run -d -p 3000:3000 -e "SECRET_KEY_BASE=abcd1234" gcr.io/${PROJECT_NAME}/myghost:$CIRCLE_SHA1; sleep 10
    - sudo /opt/google-cloud-sdk/bin/gcloud docker push gcr.io/${PROJECT_NAME}/myghost:$CIRCLE_SHA1
    - sudo chown -R ubuntu:ubuntu /home/ubuntu/.kube
    - sudo kubectl get deployments
    - sudo kubectl patch deployment myghost -p {"spec":{"template":{"spec":{"containers":[{"name":"myghost","image":"gcr.io/${PROJECT_NAME}/myghost:$CIRCLE_SHA1"}]}}}}
# deployment:
#   prod:
#     branch: master
#     commands:
#       - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS $EXTERNAL_REGISTRY_ENDPOINT
#       - envsubst < .kubernetes_auth.template > ~/.kubernetes_auth
#       - ./deploy.sh